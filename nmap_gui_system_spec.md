# Nmap GUI Discovery & Rating System 仕様書

## 1. 概要
本システムは **nmap を外部コマンドとして利用するローカルGUIアプリケーション**であり、  
軽量ディスカバリ（ICMP / ポート / OS 推定）に基づき、  
**脆弱性スキャン対象の優先度（レーティング）を自動判定するツール**である。

nmap を内部に組み込むのではなく、あくまで **外部プロセスとして subprocess で実行**する構成とし、  
OSS として公開可能なアーキテクチャで設計する。

---

## 2. 特徴
- ローカルで動作する軽量 GUI アプリ（PySide6 / PyQt6 など想定）
- nmap の結果を独自レーティングルールに従ってスコアリング
- 有償スキャナ投入対象の自動抽出
- マルチプロセスによる高速スキャン
- 結果を CSV / JSON としてエクスポート可能
- OSS として公開可能（nmap を同梱しない設計）

---

## 3. 機能一覧

### 3.1 スキャン設定パネル
- 対象 IP / CIDR の入力
- スキャンモード選択（ICMP / Ports / OS）
- 実行・停止ボタン
- スキャン進捗バー

### 3.2 スキャンエンジン（バックエンド）
- subprocess による nmap 実行
- マルチプロセス並列化（ProcessPoolExecutor）
- nmap XML 出力のパース
- スコアリングロジック適用

### 3.3 結果表示 GUI
- テーブル形式の結果一覧
- ソート・フィルタ（スコア / OS / ポート）
- 行の色分けによる危険度可視化

### 3.4 エクスポート
- CSV 出力
- JSON 出力

### 3.5 安全診断（Safe Script）
- 解析結果テーブルの各行に `nmap --script safe` を実行するボタンを配置
- 診断実行中は他の診断ボタンおよびディスカバリ開始ボタンを無効化（常に単一ジョブ）
- 実行ログ（コマンド、開始/終了時刻、stdout/stderr、エラー）をダイアログで表示し、そのままテキストとして保存可能
- ファイル名は `safe-scan_<target>_<timestamp>.txt` を自動提案し、上書き事故を避ける
- `-T4` を前提に標準実行時間を 2 分とした擬似プログレスバーを表示し、実測平均が 2 分を超える場合はセッション中のみその平均値を基準時間として利用する

---

## 4. スキャンフロー（3フェーズ構成）

### Phase 1：ICMP 生存確認
```
nmap -sn -PE <targets>
```

### Phase 2：ポートスキャン
対象ポート：
```
21, 22, 80, 139, 443, 445, 1433, 3000, 3306,
3389, 5432, 5672, 5900, 5985, 6379, 8000,
8080, 8888, 11211, 15672, 50000
```


※ 上記ポートセットは `rogue-finder.config.yaml` の `scan.port_scan_list` で編集可能。ファイルが存在しない場合は起動時に自動生成される。
### Phase 3：OS 推定
```
nmap -O -Pn <targets>
```

---

## 5. レーティング仕様

### 5.1 ICMP 生存
| 状態 | 点数 |
|------|------|
| 応答あり | +2 |
| 応答なし | +0 |

### 5.2 ポート危険度
| ポート | 点数 |
|--------|------|
| 21, 445, 3389, 5985 | +2 |
| 6379 / 11211 / 5672 / 15672 | +2 |
| 1433 / 3306 / 5432 | +1 |
| 3000 / 8000 / 8080 / 8888 | +1 |

### 5.3 OS 推定
| OS 種別 | 点数 |
|--------|------|
| Windows | +3 |
| SOHO / IoT | +3 |
| 古い Linux | +2 |
| サーバ Linux | +1 |
| 不明 | +1 |

### 5.4 組み合わせ評価
| 組み合わせ | 点数 |
|------------|------|
| 22 + (3306 / 5432) | +2 |
| 3389 + 1433 | +2 |
| 8080 + 5672 + 15672 | +3 |

### 5.5 高番ポート
| 条件 | 点数 |
|------|------|
| 50000 が開いている | +1 |

※ これらのレーティング設定（ICMP/ポート/OS/コンボ/優先度）は `rogue-finder.config.yaml` の `rating` セクションで外部化されており、ファイルを編集することでビルド無しで調整できる。

---

## 6. スコア基準
| スコア | 優先度 |
|--------|--------|
| 8以上 | High（有償スキャナ投入） |
| 5〜7 | Medium |
| 4以下 | Low |

---

## 7. システム構成（ローカルGUI）
```
GUI（PySide6）
 └─ ScanManager
      └─ Worker（multiprocessing）
           └─ nmap subprocess
                └─ XML Parser
                     └─ Rating Engine
                          └─ Result Table
```

---

## 8. OSS公開時の注意
- nmap をバンドルしない（ユーザーインストール前提）
- README に NPSL と nmap の利用について注意書きを追加
- ライセンスは MIT / Apache-2.0 など任意で選択可

---

## 9. 今後の拡張
- SQLite 保存
- 差分検出（前回スキャンとの比較）
- ダークテーマ GUI
